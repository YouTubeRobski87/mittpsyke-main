---
layout: layouts/base.njk
title: Logga in
permalink: /login/
disableFooter: true
---

{% block headExtra %}
  <style>
    .login-shell {
      max-width: 520px;
      margin: 0 auto;
      padding: var(--space-2xl) var(--space-lg);
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(8px);
    }
    .login-title {
      text-align: center;
      margin-bottom: var(--space-sm);
      font-size: 1.75rem;
    }
    .login-lede {
      text-align: center;
      margin-bottom: var(--space-xl);
      color: var(--muted);
      line-height: 1.6;
    }
    .login-actions {
      display: grid;
      gap: var(--space-sm);
      margin-top: var(--space-lg);
    }
    .login-input {
      display: grid;
      gap: 6px;
      margin-top: var(--space-md);
    }
    .login-input label {
      color: var(--muted);
      font-size: 0.95rem;
    }
    .login-input input {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--on-surface, #f7f7ff);
    }
    .login-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: var(--on-surface, #f7f7ff);
      text-decoration: none;
      font-weight: 600;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    .login-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.16);
    }
    .login-btn.secondary {
      background: transparent;
      border-color: rgba(255, 255, 255, 0.10);
      color: var(--muted);
    }
    .login-note {
      margin-top: var(--space-lg);
      color: var(--muted);
      text-align: center;
      line-height: 1.5;
    }
    .login-footnote {
      margin-top: var(--space-sm);
      text-align: center;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .login-hint {
      margin-top: 4px;
      color: var(--muted);
      font-size: 0.95rem;
    }
  </style>
{% endblock %}

<main class="container" style="padding: var(--space-3xl) 0;">
  <div class="login-shell">
    <h1 class="login-title">Spara dina samtal (valfritt)</h1>
    <p class="login-lede">
      Om du vill kan du logga in f&ouml;r att forts&auml;tta AI-st&ouml;det &ouml;ver tid.
      Du kan ocks&aring; anv&auml;nda AI-st&ouml;det utan konto.
    </p>

    <div class="login-input">
      <label for="login-email">E-post</label>
      <input id="login-email" type="email" name="email" placeholder="din@epost.se" data-email-input />
      <p class="login-hint">Fyll i e-post och v&auml;lj Google eller E-postl&auml;nk f&ouml;r att forts&auml;tta.</p>
    </div>

    <div class="login-actions">
      <a class="login-btn" id="login-google" href="#" data-login-action="google">
        <span>Forts&auml;tt med Google</span>
      </a>
      <a class="login-btn secondary" href="#" data-login-action="magic">
        <span>F&aring; l&auml;nk via e-post (magic link)</span>
      </a>
    </div>

    <p class="login-note">
      Inloggning g&ouml;r att AI-st&ouml;det kan minnas vad ni pratat om.
      Du best&auml;mmer alltid sj&auml;lv vad som sparas.
    </p>

    <p class="login-footnote">Kom ih&aring;g: AI-st&ouml;det fungerar &auml;ven utan inloggning.</p>
  </div>
</main>

{% block scripts %}
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://upzfnjdqapkdgvhqxpsn.supabase.co';
    const supabaseKey =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwemZuamRxYXBrZGd2aHF4cHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NjUyNjAsImV4cCI6MjA4MTA0MTI2MH0.J-t_xkwRWvMoj0Lo5pKtglsJ3vl4L9FP3cBTo-mJtaQ';
    const redirectUrl = 'https://www.mittpsyke.se/ai/';

    const supabase = createClient(supabaseUrl, supabaseKey);
    window.mpSupabase = supabase;
    window.mpSupabaseReady = Promise.resolve(supabase);

    const googleBtn = document.getElementById('login-google');
    const magicBtn = document.querySelector('[data-login-action="magic"]');
    const emailInput = document.querySelector('[data-email-input]');
    let busy = false;

    function setButtonsEnabled(enabled) {
      busy = !enabled;
      [googleBtn, magicBtn].forEach((btn) => {
        if (!btn) return;
        btn.style.pointerEvents = enabled ? '' : 'none';
        btn.style.opacity = enabled ? '1' : '0.6';
      });
    }

    async function redirectIfLogged() {
      const { data, error } = await supabase.auth.getSession();
      if (error) {
        console.error('auth:session_error', error);
        return;
      }
      if (data && data.session) {
        window.location.href = redirectUrl;
      }
    }

    redirectIfLogged();

    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        window.location.href = redirectUrl;
      }
    });

    async function handleMagicLink() {
      if (busy) return;
      const email = emailInput ? emailInput.value.trim() : '';
      if (!email) {
        alert('Ange en e-postadress f\u00f6rst.');
        return;
      }
      setButtonsEnabled(false);
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: redirectUrl }
      });
      if (error) {
        alert('Kunde inte skicka l\u00e4nk: ' + error.message);
      } else {
        alert('Kolla din e-post f\u00f6r en magisk l\u00e4nk.');
      }
      setButtonsEnabled(true);
    }

    async function handleGoogle() {
      if (busy) return;
      setButtonsEnabled(false);
      const { error, data } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: redirectUrl }
      });
      if (error) {
        alert(error.message);
      } else if (data?.url) {
        window.location.href = data.url;
      } else {
        alert('Kunde inte starta Google-inloggning (saknar redirect-URL).');
      }
      setButtonsEnabled(true);
    }

    if (googleBtn) googleBtn.addEventListener('click', (e) => { e.preventDefault(); handleGoogle(); });
    if (magicBtn) magicBtn.addEventListener('click', (e) => { e.preventDefault(); handleMagicLink(); });
  </script>
{% endblock %}
